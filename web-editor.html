<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Primary Meta Tags -->
  <title>Script Api Editor</title>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Script Api Editor" />
  <meta property="og:description"
    content="A simple web-based code editor for Minecraft Bedrock Edition scripting with real-time autocomplete." />

  <meta property="og:image"
    content="https://minato-mba.github.io/web-apps/content/pictures/web-editor/screenshot.png" />
  <meta property="og:image:width" content="1350" />
  <meta property="og:image:height" content="643" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta property="twitter:image"
    content="https://minato-mba.github.io/web-apps/content/pictures/web-editor/screenshot.png" />

  <meta name="theme-color" content="#1e1e1e" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#f3f3f3" media="(prefers-color-scheme: light)" />
  <meta name="apple-mobile-web-app-title" content="Script Api Editor" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="msapplication-TileColor" content="#1e1e1e" />

  <link rel="icon" type="image/x-icon" href="content/pictures/web-editor/web-editor.png" />
  <style>
    :root {
      /* dark theme (default) */
      --bg-color: #1e1e1e;
      --text-color: #d4d4d4;
      --button-bg: #3c3c3c;
      --button-border: #454545;
      --modal-bg: #2d2d2d;
      --input-bg: #3c3c3c;
      --hover-brightness: 1.15;
      --scrollbar-color: #3c3c3c;
      --scrollbar-thumb: #606060;
      --file-hover: #2a2d2e;
      --file-active: #094771;
      --file-icon: #cccccc;
      --folder-icon: #c09553;
    }

    [data-theme="hc-black"] {
      /* high contrast theme */
      --bg-color: #000000;
      --text-color: #ffffff;
      --button-bg: #000000;
      --button-border: #ffffff;
      --modal-bg: #000000;
      --input-bg: #000000;
      --hover-brightness: 1.25;
      --scrollbar-color: #000000;
      --scrollbar-thumb: #ffffff;
      --file-hover: #333333;
      --file-active: #ffffff;
      --file-icon: #ffffff;
      --folder-icon: #ffffff;
    }

    [data-theme="vs"] {
      /* light theme */
      --bg-color: #f3f3f3;
      --text-color: #333333;
      --button-bg: #e0e0e0;
      --button-border: #cccccc;
      --modal-bg: #ffffff;
      --input-bg: #ffffff;
      --hover-brightness: 0.95;
      --scrollbar-color: #e0e0e0;
      --scrollbar-thumb: #b0b0b0;
      --file-hover: #e8e8e8;
      --file-active: #cce5ff;
      --file-icon: #424242;
      --folder-icon: #dcb67a;
    }

    [data-theme="dracula"] {
      /* dark-blue theme */
      --bg-color: #282a36;
      --text-color: #f8f8f2;
      --button-bg: #44475a;
      --button-border: #6272a4;
      --modal-bg: #44475a;
      --input-bg: #44475a;
      --hover-brightness: 1.15;
      --scrollbar-color: #44475a;
      --scrollbar-thumb: #6272a4;
    }

    [data-theme="monokai"] {
      /* monokai (dark-green) theme */
      --bg-color: #272822;
      --text-color: #f8f8f2;
      --button-bg: #3e3d32;
      --button-border: #75715e;
      --modal-bg: #3e3d32;
      --input-bg: #3e3d32;
      --hover-brightness: 1.15;
      --scrollbar-color: #3e3d32;
      --scrollbar-thumb: #75715e;
    }

    [data-theme="solarized-dark"] {
      --bg-color: #002b36;
      --text-color: #839496;
      --button-bg: #073642;
      --button-border: #586e75;
      --modal-bg: #073642;
      --input-bg: #073642;
      --hover-brightness: 1.15;
      --scrollbar-color: #073642;
      --scrollbar-thumb: #586e75;
    }

    [data-theme="solarized-light"] {
      --bg-color: #fdf6e3;
      --text-color: #657b83;
      --button-bg: #eee8d5;
      --button-border: #93a1a1;
      --modal-bg: #eee8d5;
      --input-bg: #eee8d5;
      --hover-brightness: 0.95;
      --scrollbar-color: #eee8d5;
      --scrollbar-thumb: #93a1a1;
    }

    [data-theme="nord"] {
      --bg-color: #2e3440;
      --text-color: #d8dee9;
      --button-bg: #3b4252;
      --button-border: #4c566a;
      --modal-bg: #3b4252;
      --input-bg: #3b4252;
      --hover-brightness: 1.15;
      --scrollbar-color: #3b4252;
      --scrollbar-thumb: #4c566a;
    }

    [data-theme="gruvbox"] {
      --bg-color: #282828;
      --text-color: #ebdbb2;
      --button-bg: #3c3836;
      --button-border: #665c54;
      --modal-bg: #3c3836;
      --input-bg: #3c3836;
      --hover-brightness: 1.15;
      --scrollbar-color: #3c3836;
      --scrollbar-thumb: #665c54;
    }

    body {
      margin: 0;
      padding: 10px;
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      -webkit-font-smoothing: antialiased;
    }

    .loading-bar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background-color: var(--button-border);
      z-index: 1001;
    }

    .loading-progress {
      height: 100%;
      width: 0;
      background-color: limegreen;
      transition: width 0.3s ease;
    }

    #toolbar-container {
      position: relative;
      margin-bottom: 10px;
    }

    #toolbar-toggle {
      top: -10px;
      padding: 4px 8px;
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      font-size: 12px;
      z-index: 2;
      white-space: nowrap;
      text-align: center;
    }

    #toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      transition: all 0.3s ease;
      overflow: hidden;
      height: 0;
      opacity: 0;
    }

    #toolbar.visible {
      height: auto;
      opacity: 1;
      padding: 8px 0;
    }

    .toolbar-btn {
      padding: 12px 16px;
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      white-space: nowrap;
      font-size: 14px;
      flex: 1 1 auto;
    }

    .toolbar-btn:hover {
      filter: brightness(var(--hover-brightness));
    }

    .toolbar-input {
      padding: 12px;
      background: var(--input-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      border-radius: 4px;
      font-family: Arial, sans-serif;
      flex: 2 1 200px;
      min-width: 120px;
      font-size: 14px;
    }

    #editor {
      width: 100%;
      height: calc(100vh - 70px);
      border: 1px solid var(--button-border);
      border-radius: 4px;
      touch-action: manipulation;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }

    .modal-content {
      position: relative;
      background: var(--modal-bg);
      margin: auto;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid var(--button-border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 24px;
      padding: 0 8px;
      color: var(--text-color);
    }

    .modal-close:hover {
      opacity: 0.8;
    }

    .settings-group {
      margin-bottom: 15px;
    }

    .settings-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .version-select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background: var(--input-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      border-radius: 4px;
    }

    .module-label {
      margin: 8px 0 4px;
      font-size: 0.9em;
      color: var(--text-color);
      opacity: 0.8;
    }

    @media (max-width: 480px) {
      .toolbar-btn {
        padding: 14px 12px;
        font-size: 13px;
      }

      .toolbar-input {
        flex-basis: 100%;
      }

      #editor {
        height: calc(100vh - 90px);
      }
    }

    /* monaco editor overrides */
    .monaco-editor .line-numbers {
      font-size: 12px !important;
      padding-left: 5px !important;
      color: var(--text-color) !important;
    }

    .monaco-editor .margin-view-overlays {
      width: 40px !important;
      background: var(--bg-color) !important;
    }

    /* scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      background-color: var(--scrollbar-color);
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 4px;
    }

    #error-container,
    #notification-container {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10000;
    }

    .error-toast,
    .notification {
      background: #ff4444;
      color: white;
      width: 40%;
      padding: 12px;
      margin: 10px;
      border-radius: 4px;
      text-align: center;
      opacity: 0;
      transform: translateY(-20px);
      animation: fadeInOut 4s ease-in-out;
    }

    .notification {
      background: #44ff5d;
    }

    @keyframes fadeInOut {
      0% {
        opacity: 0;
        transform: translateY(-20px);
      }

      10% {
        opacity: 1;
        transform: translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-20px);
      }
    }

    .selections {
      position: absolute;
      z-index: 10;
    }

    .hidden {
      display: none;
    }

    .selectors {
      width: 25px;
      height: 25px;
      background: #7a77ff;
      position: absolute;
      border-radius: 50%;
      margin-top: 25px;
      box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
      transition: transform 0.1s ease;
      z-index: 2000;
    }

    .right-selector {
      border-top-left-radius: 0;
      margin-left: -8px;
    }

    .left-selector {
      border-top-right-radius: 0;
      margin-left: -35px;
    }

    .mnc {
      padding: 10px;
      cursor: pointer;
      user-select: none;
    }

    .hovered {
      background-color: #ccc;
    }

    .right-arrow-mnc,
    .left-arrow-mnc {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background-color: blue;
      border-radius: 50%;
      cursor: pointer;
    }

    .right-arrow-mnc {
      right: 10px;
    }

    .left-arrow-mnc {
      left: 10px;
    }

    .arrow-container {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: none;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      padding: 10px;
      background: var(--bg-color);
      border: 1px solid var(--button-border);
      border-radius: 8px;
      max-width: 300px;
      margin: auto;
      z-index: 99999;
    }

    .left-arrow {
      grid-row: span 3;
    }

    .right-arrow {
      grid-row: span 3;
    }

    .file-system-container {
      display: flex;
      width: 100%;
      height: calc(100vh - 70px);
    }

    .file-tree {
      width: 250px;
      height: 100%;
      background: var(--bg-color);
      border-right: 1px solid var(--button-border);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .file-tree-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--button-border);
    }
    
    .file-tree-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: normal;
    }
    
    .file-tree-actions {
      display: flex;
      gap: 5px;
    }
    
    .file-tree-action {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 5px;
    }
    
    .file-tree-action:hover {
      filter: brightness(var(--hover-brightness));
    }

    .file-tree-content {
      flex: 1;
      padding: 5px;
      overflow-y: auto;
    }

    .file-tree-item {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-tree-item:hover {
      background-color: var(--file-hover);
    }

    .file-tree-item.active {
      background-color: var(--file-active);
    }

    .file-icon {
      margin-right: 5px;
      color: var(--file-icon);
      width: 16px;
      text-align: center;
    }

    .folder-icon {
      color: var(--folder-icon);
    }

    .file-tree-item .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-tree-folder {
      margin-left: 0;
    }

    .file-tree-folder-content {
      margin-left: 10px;
      border-left: 1px dashed var(--button-border);
      padding-left: 5px;
      display: none;
    }

    .file-tree-folder.expanded > .file-tree-folder-content {
      display: block;
    }

    .file-tree-item .file-actions {
      display: none;
      margin-left: auto;
    }

    .file-tree-item:hover .file-actions {
      display: flex;
    }

    .file-action {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 12px;
      padding: 0 2px;
      opacity: 0.7;
    }

    .file-action:hover {
      opacity: 1;
    }

    .editor-container {
      flex: 1;
      height: 100%;
    }

    #editor {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0;
    }

    .file-context-menu {
      position: fixed;
      z-index: 1000;
      background: var(--bg-color);
      border: 1px solid var(--button-border);
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      min-width: 150px;
      display: none;
    }

    .context-menu-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .context-menu-item:hover {
      background-color: var(--file-hover);
    }

    .context-menu-item i {
      margin-right: 8px;
      width: 16px;
      text-align: center;
    }

    /* Modal for file operations */
    .file-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }

    .file-modal-content {
      position: relative;
      background: var(--modal-bg);
      margin: auto;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid var(--button-border);
    }

    .file-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .file-modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .file-modal-close {
      cursor: pointer;
      font-size: 24px;
      padding: 0 8px;
      color: var(--text-color);
    }

    .file-modal-body {
      margin-bottom: 20px;
    }

    .file-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
  </style>
</head>

<body>
  <!-- loading bar -->
  <div id="loadingBar" class="loading-bar">
    <div class="loading-progress"></div>
  </div>
  <!-- error container -->
  <div id="error-container"></div>
  <div id="notification-container"></div>
  <div id="toolbar-container">
    <div id="toolbar-toggle" onclick="toggleToolbar()">▽ Show Toolbar</div>
    <div id="toolbar">
      <input type="text" class="toolbar-input" id="filename" value="main.js" />
      <button class="toolbar-btn" onclick="saveCode()">💾 Save</button>
      <button class="toolbar-btn" onclick="formatCode()">✨ Format</button>
      <button class="toolbar-btn" onclick="copy()">Copy</button>
      <button class="toolbar-btn" onclick="copyWithCodeBlock()">Copy &lt;&gt;</button>
      <button class="toolbar-btn" onclick="showSettings()">⚙️ Settings</button>
      <button class="toolbar-btn" onclick="showVersions()">📦 Modules</button>
      <button class="toolbar-btn" id="compileBtn" onclick="compileTypeScript()">🔄 Compile TS</button>
    </div>
    <!-- selection menu -->
    <div id="arrow-layout" class="arrow-container hidden">
      <button class="toolbar-btn left-arrow" onclick="selectMove('left')">&#8592;</button>
      <button class="toolbar-btn up-arrow" onclick="selectMove('up')">&#8593;</button>
      <button class="toolbar-btn right-arrow" onclick="selectMove('right')">&#8594;</button>
      <button class="toolbar-btn" onabort="copy()">Copy</button>
      <button class="toolbar-btn down-arrow" onclick="selectMove('down')">&#8595;</button>
      <button class="toolbar-btn home-arrow" onclick="selectMove('home')">&#8676;</button>
      <button class="toolbar-btn" onabort="paste()">Paste</button>
      <button class="toolbar-btn end-arrow" onclick="selectMove('end')">&#8677;</button>
      <button class="toolbar-btn" onclick="selectAll()">Select All</button>
      <button class="toolbar-btn" onclick="formatSelection()">Format</button>
      <button class="toolbar-btn" onclick="cut()">Cut</button>
    </div>
  </div>
  <div class="file-system-container">
    <div class="file-tree">
      <div class="file-tree-header">
        <h3>Files</h3>
        <div class="file-tree-actions">
          <button class="file-tree-action" id="new-file" title="New File"><i>+</i></button>
          <button class="file-tree-action" id="new-folder" title="New Folder"><i>📁+</i></button>
          <button class="file-tree-action" id="download-workspace" title="Download Workspace"><i>💾</i></button>
        </div>
      </div>
      <div class="file-tree-content" id="file-tree-content">
        <!-- Files will be added dynamically here -->
      </div>
    </div>
    <div class="editor-container">
      <div id="editor"></div>
    </div>
  </div>

  <!-- Context menu -->
  <div class="file-context-menu" id="file-context-menu">
    <div class="context-menu-item" id="context-rename">
      <i>✏️</i> Rename
    </div>
    <div class="context-menu-item" id="context-duplicate">
      <i>🔄</i> Duplicate
    </div>
    <div class="context-menu-item" id="context-delete">
      <i>🗑️</i> Delete
    </div>
  </div>

  <!-- File operation modals -->
  <div class="file-modal" id="new-file-modal">
    <div class="file-modal-content">
      <div class="file-modal-header">
        <h3>New File</h3>
        <span class="file-modal-close" onclick="closeFileModal('new-file-modal')">&times;</span>
      </div>
      <div class="file-modal-body">
        <label for="new-file-name">File name:</label>
        <input type="text" id="new-file-name" class="toolbar-input" placeholder="e.g., script.js" />
      </div>
      <div class="file-modal-footer">
        <button class="toolbar-btn" onclick="closeFileModal('new-file-modal')">Cancel</button>
        <button class="toolbar-btn" id="create-file-btn">Create</button>
      </div>
    </div>
  </div>

  <div class="file-modal" id="new-folder-modal">
    <div class="file-modal-content">
      <div class="file-modal-header">
        <h3>New Folder</h3>
        <span class="file-modal-close" onclick="closeFileModal('new-folder-modal')">&times;</span>
      </div>
      <div class="file-modal-body">
        <label for="new-folder-name">Folder name:</label>
        <input type="text" id="new-folder-name" class="toolbar-input" placeholder="e.g., src" />
      </div>
      <div class="file-modal-footer">
        <button class="toolbar-btn" onclick="closeFileModal('new-folder-modal')">Cancel</button>
        <button class="toolbar-btn" id="create-folder-btn">Create</button>
      </div>
    </div>
  </div>

  <div class="file-modal" id="rename-modal">
    <div class="file-modal-content">
      <div class="file-modal-header">
        <h3>Rename</h3>
        <span class="file-modal-close" onclick="closeFileModal('rename-modal')">&times;</span>
      </div>
      <div class="file-modal-body">
        <label for="rename-input">New name:</label>
        <input type="text" id="rename-input" class="toolbar-input" />
      </div>
      <div class="file-modal-footer">
        <button class="toolbar-btn" onclick="closeFileModal('rename-modal')">Cancel</button>
        <button class="toolbar-btn" id="rename-btn">Rename</button>
      </div>
    </div>
  </div>

  <div class="file-modal" id="delete-confirm-modal">
    <div class="file-modal-content">
      <div class="file-modal-header">
        <h3>Delete</h3>
        <span class="file-modal-close" onclick="closeFileModal('delete-confirm-modal')">&times;</span>
      </div>
      <div class="file-modal-body" id="delete-confirm-message">
        Are you sure you want to delete this file?
      </div>
      <div class="file-modal-footer">
        <button class="toolbar-btn" onclick="closeFileModal('delete-confirm-modal')">Cancel</button>
        <button class="toolbar-btn" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <!-- settings menu -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editor Settings</h3>
        <span class="modal-close" onclick="closeModal('settingsModal')">&times;</span>
      </div>
      <div class="settings-group">
        <label><input type="checkbox" id="minimap" /> Show Minimap</label>
        <label><input type="checkbox" id="wordWrap" checked />Wrap Lines</label>
        <label>Font Size <input type="number" id="fontSize" value="13" min="8" max="24" class="toolbar-input" /></label>
        <label><input type="checkbox" id="lineNumbers" checked /> Show Line Numbers</label>
        <label><input type="checkbox" id="renderWhitespace" /> Render Whitespace</label>
        <label>Theme
          <select id="theme" class="toolbar-input">
            <option value="vs-dark" selected>Dark</option>
            <option value="vs">Light</option>
            <option value="hc-black">High Contrast</option>
            <option value="dracula">Dracula</option>
            <option value="monokai">Monokai</option>
            <option value="solarized-dark">Solarized Dark</option>
            <option value="solarized-light">Solarized Light</option>
            <option value="nord">Nord</option>
            <option value="gruvbox">Gruvbox</option>
          </select></label>
        <label><input type="checkbox" id="autoClosingBrackets" checked /> Auto Closing Brackets</label>
        <label>Auto-Save Interval (seconds)
          <input type="number" id="autoSaveInterval" min="5" value="30" class="toolbar-input" checked />
        </label>
        <label><input type="checkbox" id="autoSaveEnabled" onchange="toggleInput()" /> Enable Auto-Save</label>
        <label>Language
          <select id="language" class="toolbar-input">
            <option value="javascript">JavaScript</option>
            <option value="typescript">TypeScript</option>
          </select></label>
      </div>
      <button class="toolbar-btn" onclick="applySettings()">Apply</button>
    </div>
  </div>

  <!-- version selection menu -->
  <div id="versionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Module Versions</h3>
        <span class="modal-close" onclick="closeModal('versionModal')">&times;</span>
      </div>
      <div class="settings-group" id="versionSelectors">
        <!-- modules versions will be added here dynamically -->
      </div>
      <button class="toolbar-btn" onclick="loadSelectedVersions()">Load Versions</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.3.3/typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/eruda/3.4.1/eruda.min.js"
    integrity="sha512-3RVqOZtMevFOLeXCp0/Wl7np/l3J3MMysaFDUhNh+hdKx+Wb0lMXuHwA6CZ/+4DfYZM01Om1as8g+mnTaQH9vA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    function toggleInput() {
      document.getElementById("autoSaveInterval").disabled = !document.getElementById("autoSaveEnabled").checked;
    }

    let errorCount = 0;
    function showError(message) {
      errorCount += 1;
      const errorContainer = document.getElementById("error-container");
      const toast = document.createElement("div");
      toast.className = "error-toast";
      toast.textContent = message;

      setTimeout(() => {
        errorContainer.appendChild(toast);
        setTimeout(() => {
          toast.remove();
          errorCount -= 1;
        }, 2500);
      }, errorCount * 20);
    }

    let notificationCount = 0;
    function showNotification(message) {
      notificationCount += 1;
      const notificationContainer = document.getElementById("notification-container");
      const toast = document.createElement("div");
      toast.className = "notification";
      toast.textContent = message;

      setTimeout(() => {
        notificationContainer.appendChild(toast);
        setTimeout(() => {
          toast.remove();
          notificationCount -= 1;
        }, 4000);
      }, notificationCount * 500);
    }
    // ========== modules ========== //
    // add new modules here following the same format
    const MODULES = [
      {
        name: "@minecraft/server",
        selectorId: "minecraft-server",
        currentVersion: "1.17.0-beta.1.21.51-stable",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/server@${version}/index.d.ts`,
      },
      {
        name: "@minecraft/server-ui",
        selectorId: "minecraft-server-ui",
        currentVersion: "1.3.0",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/server-ui@${version}/index.d.ts`,
      },
      {
        name: "@minecraft/server-net",
        selectorId: "minecraft-server-net",
        currentVersion: "1.0.0-beta.1.21.51-stable",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/server-net@${version}/index.d.ts`,
      },
      {
        name: "@minecraft/server-admin",
        selectorId: "minecraft-server-admin",
        currentVersion: "1.0.0-beta.1.21.51-stable",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/server-admin@${version}/index.d.ts`,
      },
      {
        name: "@minecraft/math",
        selectorId: "minecraft-math",
        currentVersion: "2.0.1",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/math@${version}/dist/minecraft-math.d.ts`,
      },
      {
        name: "@minecraft/vanilla-data",
        selectorId: "minecraft-vanilla-data",
        currentVersion: "1.21.50",
        typesUrl: (version) => `https://cdn.jsdelivr.net/npm/@minecraft/vanilla-data@${version}/lib/index.d.ts`,
      },
    ];

    const defaultCode = `// Minecraft scripting with full autocomplete capabilities\nimport { world, ItemStack } from '@minecraft/server';\nimport { ActionFormData } from '@minecraft/server-ui';\n\nworld.beforeEvents.itemUse.subscribe((event) => {\n    const { source, itemStack } = event;\n    if (itemStack.typeId !== "minecraft:stick") return;\n    new ActionFormData()\n        .title("Special Offer!")\n        .body("Do you want a free diamond?")\n        .button("Yes!")\n        .button("No")\n        .show(source)\n        .then(({ selection }) => {\n            if (selection !== 0) return;\n            source.getComponent("minecraft:inventory")?.container?.addItem(new ItemStack("minecraft:diamond", 1));\n            source.sendMessage("You received a free diamond!");\n        })\n});`;
    let editor;
    let typeLibs = new Map();
    let isToolbarVisible = false;

    /*------loading bar related functions------ */
    function showLoadingBar() {
      document.getElementById("loadingBar").style.display = "block";
      document.querySelector(".loading-progress").style.width = "0";
    }
    function updateLoadingProgress(current, total) {
      document.querySelector(".loading-progress").style.width = `${(current / total) * 100}%`;
    }
    function hideLoadingBar() {
      setTimeout(() => {
        document.getElementById("loadingBar").style.display = "none";
      }, 300);
    }
    function toggleToolbar() {
      isToolbarVisible = !isToolbarVisible;
      const toolbar = document.getElementById("toolbar");
      const toggleBtn = document.getElementById("toolbar-toggle");

      toolbar.classList.toggle("visible", isToolbarVisible);
      toggleBtn.textContent = `${isToolbarVisible ? "△ Hide" : "▽ Show"} Toolbar`;
    }

    /*------type definition related functions------ */

    async function loadTypeDefinitions() {
      showLoadingBar();
      monaco.languages.typescript.javascriptDefaults.setCompilerOptions({
        allowNonTsExtensions: true,
        moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
        target: monaco.languages.typescript.ScriptTarget.ES2020,
        checkJs: true,
      });

      monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
        allowNonTsExtensions: true,
        moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
        target: monaco.languages.typescript.ScriptTarget.ES2020,
        strict: true,
      });

      typeLibs.forEach((lib) => {
        lib.jsLib?.dispose();
        lib.tsLib?.dispose();
      });
      typeLibs.clear();

      const totalModules = MODULES.length;
      let loadedModules = 0;

      for (const module of MODULES) {
        try {
          const response = await fetch(module.typesUrl(module.currentVersion));
          if (!response.ok) {
            showError(`Failed to load ${module.name}@${module.currentVersion}`);
            throw new Error(`HTTP ${response.status}`);
          }
          const types = await response.text();

          const libJS = monaco.languages.typescript.javascriptDefaults.addExtraLib(`declare module "${module.name}" { ${types} }`, `file:///node_modules/${module.name}/index.d.ts`);
          const libTS = monaco.languages.typescript.typescriptDefaults.addExtraLib(`declare module "${module.name}" { ${types} }`, `file:///node_modules/${module.name}/index.d.ts`);

          typeLibs.set(module.name, { jsLib: libJS, tsLib: libTS });
        } catch (error) {
          console.error(`Failed to load ${module.name}@${module.currentVersion}:`, error);
          showError(`Failed to load ${module.name}@${module.currentVersion}`);
        }
        loadedModules++;
        updateLoadingProgress(loadedModules, totalModules);
      }
      hideLoadingBar();
    }

    async function loadSelectedVersions() {
      showLoadingBar();

      for (const module of MODULES) {
        const selectedVersion = document.getElementById(module.selectorId).value;
        console.log(`Updating ${module.name} to version ${selectedVersion}`);
        module.currentVersion = selectedVersion;
      }

      await loadTypeDefinitions();
      closeModal("versionModal");
      editor.setValue(editor.getValue());

      hideLoadingBar();
    }

    let isClicked = false;
    async function showVersions() {
      if (isClicked) return;
      editor.setSelection({ startLineNumber: 1, startColumn: 1, endLineNumber: 1, endColumn: 1 });
      document.activeElement?.blur();
      isClicked = true;
      const versionSelectors = document.getElementById("versionSelectors");
      versionSelectors.innerHTML = "";

      const totalModules = MODULES.length;
      let loadedModules = 0;

      showLoadingBar();

      for (const module of MODULES) {
        const versions = await fetchVersions(module.name);
        const select = createVersionSelector(module, versions);
        versionSelectors.appendChild(select);
        loadedModules++;
        updateLoadingProgress(loadedModules, totalModules);
      }

      hideLoadingBar();

      isClicked = false;
      document.getElementById("versionModal").style.display = "block";
    }

    async function fetchVersions(packageName) {
      try {
        const response = await fetch(`https://data.jsdelivr.com/v1/package/npm/${packageName}`);
        if (!response.ok) {
          showError(`Failed to fetch versions for ${packageName}`);
          throw new Error(`Failed to fetch versions for ${packageName}: HTTP ${response.status}`);
        }
        const data = await response.json();
        return data.versions.reverse();
      } catch (error) {
        showError(`Failed to fetch versions for ${packageName}`);
        console.error(`Failed to fetch versions for ${packageName}:`, error);
        return [];
      }
    }

    function createVersionSelector(module, versions) {
      const container = document.createElement("div");
      const label = document.createElement("div");
      label.className = "module-label";
      label.textContent = module.name;

      const select = document.createElement("select");
      select.className = "version-select";
      select.id = module.selectorId;
      select.innerHTML = versions.map((v) => `<option value="${v}" ${v === module.currentVersion ? "selected" : ""}>${v}</option>`).join("");

      container.appendChild(label);
      container.appendChild(select);

      if (versions.length === 0) {
        select.disabled = true;
        select.innerHTML = `<option>No versions available</option>`;
      }
      return container;
    }

    /*------settings related functions------ */
    function getSettingElements() {
      return {
        miniMap: document.getElementById("minimap"),
        wordWrap: document.getElementById("wordWrap"),
        fontSize: document.getElementById("fontSize"),
        lineNumbers: document.getElementById("lineNumbers"),
        renderWhitespace: document.getElementById("renderWhitespace"),
        theme: document.getElementById("theme"),
        autoClosingBrackets: document.getElementById("autoClosingBrackets"),
        autoSaveInterval: document.getElementById("autoSaveInterval"),
        autoSaveEnabled: document.getElementById("autoSaveEnabled"),
        language: document.getElementById("language"),
      };
    }

    function getStoredSettings() {
      return {
        storedMinimap: localStorage.getItem("minimap"),
        storedWordWrap: localStorage.getItem("wordWrap"),
        storedFontSize: localStorage.getItem("fontSize"),
        storedLineNumbers: localStorage.getItem("lineNumbers"),
        storedRenderWhitespace: localStorage.getItem("renderWhitespace"),
        storedTheme: localStorage.getItem("theme"),
        storedAutoClosingBrackets: localStorage.getItem("autoClosingBrackets"),
        storedAutoSaveInterval: localStorage.getItem("autoSaveInterval"),
        storedAutoSaveEnabled: localStorage.getItem("autoSaveEnabled"),
        storedLanguage: localStorage.getItem("language"),
      };
    }
    function showSettings() {
      editor.setSelection({ startLineNumber: 1, startColumn: 1, endLineNumber: 1, endColumn: 1 });
      document.activeElement?.blur();
      const { miniMap, wordWrap, fontSize, lineNumbers, renderWhitespace, theme, autoClosingBrackets, language } = getSettingElements();

      if (minimap && wordWrap && fontSize && lineNumbers && renderWhitespace && theme && autoClosingBrackets && language) {
        document.getElementById("settingsModal").style.display = "block";
      } else {
        showError("One or more settings elements are missing in the DOM.");
        console.error("One or more settings elements are missing in the DOM.");
      }
    }
    function applySettings() {
      startAutoSave();
      const theme = document.getElementById("theme").value;
      const selectedLanguage = document.getElementById("language").value;
      const compileBtn = document.getElementById("compileBtn");
      if (compileBtn) compileBtn.style.display = selectedLanguage === "typescript" ? "block" : "none";
      document.body.setAttribute("data-theme", theme);
      const selectedTheme = document.getElementById("theme").value;
      editor.updateOptions({
        theme: selectedTheme,
        autoClosingBrackets: document.getElementById("autoClosingBrackets").checked,
        wordWrap: document.getElementById("wordWrap").checked ? "on" : "off",
        fontSize: parseInt(document.getElementById("fontSize").value, 10),
        lineNumbers: document.getElementById("lineNumbers").checked ? "on" : "off",
        renderWhitespace: document.getElementById("renderWhitespace").checked ? "all" : "none",
        minimap: { enabled: document.getElementById("minimap").checked },
      });
      const model = editor.getModel();
      monaco.editor.setModelLanguage(model, selectedLanguage);

      // Apply body class for theme change
      document.body.classList.remove("high-contrast-theme", "light-theme");
      if (selectedTheme === "vs") {
        document.body.classList.add("light-theme");
      } else if (selectedTheme === "hc-black") {
        document.body.classList.add("high-contrast-theme");
      } else {
        document.body.classList.remove("light-theme", "high-contrast-theme");
      }

      closeModal("settingsModal");
      saveSetting();
    }

    function saveSetting() {
      const { miniMap, wordWrap, fontSize, lineNumbers, renderWhitespace, theme, autoClosingBrackets } = getSettingElements();

      localStorage.setItem("minimap", miniMap.checked);
      localStorage.setItem("wordWrap", wordWrap.checked);
      localStorage.setItem("fontSize", fontSize.value);
      localStorage.setItem("lineNumbers", lineNumbers.checked);
      localStorage.setItem("renderWhitespace", renderWhitespace.checked);
      localStorage.setItem("theme", theme.value);
      localStorage.setItem("autoClosingBrackets", autoClosingBrackets.checked);
      localStorage.setItem("autoSaveInterval", autoSaveInterval.value);
      localStorage.setItem("autoSaveEnabled", autoSaveEnabled.checked);
      localStorage.setItem("language", language.value);
    }

    function loadSetting() {
      const { miniMap, wordWrap, fontSize, lineNumbers, renderWhitespace, theme, autoClosingBrackets, language } = getSettingElements();
      const {
        storedMinimap,
        storedWordWrap,
        storedFontSize,
        storedLineNumbers,
        storedRenderWhitespace,
        storedTheme,
        storedAutoClosingBrackets,
        storedAutoSaveInterval,
        storedAutoSaveEnabled,
        storedLanguage,
      } = getStoredSettings();

      miniMap.checked = storedMinimap ? storedMinimap === "true" : false;
      wordWrap.checked = storedWordWrap ? storedWordWrap === "true" : false;
      fontSize.value = storedFontSize || 13;
      lineNumbers.checked = storedLineNumbers ? storedLineNumbers === "true" : true;
      renderWhitespace.checked = storedRenderWhitespace ? storedRenderWhitespace === "true" : false;
      theme.value = storedTheme || "vs-dark";
      autoClosingBrackets.checked = storedAutoClosingBrackets ? storedAutoClosingBrackets === "true" : true;
      autoSaveInterval.value = storedAutoSaveInterval || 30;
      autoSaveEnabled.checked = storedAutoSaveEnabled ? storedAutoSaveEnabled === "true" : true;
      language.value = storedLanguage || "javascript";
    }

    async function initializeEditor() {
      loadSetting();
      // Add theme initialization
      const savedTheme = localStorage.getItem("theme") || "vs-dark";
      document.body.setAttribute("data-theme", savedTheme);
      require.config({
        paths: {
          vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs",
        },
      });
      require(["vs/editor/editor.main"], async () => {
        await loadTypeDefinitions();

        // ========== THEMES ========== //
        // add new themes here following the same format
        monaco.editor.defineTheme("dracula", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "", foreground: "#f8f8f2", background: "#282a36" },
            { token: "comment", foreground: "#6272a4" },
            { token: "keyword", foreground: "#ff79c6" },
            { token: "number", foreground: "#bd93f9" },
            { token: "string", foreground: "#f1fa8c" },
            { token: "identifier", foreground: "#50fa7b" },
          ],
          colors: {
            "editor.background": "#282a36",
            "editor.foreground": "#f8f8f2",
            "editor.lineHighlightBackground": "#44475a",
            "editorLineNumber.foreground": "#6272a4",
          },
        });

        monaco.editor.defineTheme("monokai", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "", foreground: "#f8f8f2", background: "#272822" },
            { token: "comment", foreground: "#75715e" },
            { token: "keyword", foreground: "#f92672" },
            { token: "number", foreground: "#ae81ff" },
            { token: "string", foreground: "#e6db74" },
            { token: "identifier", foreground: "#a6e22e" },
          ],
          colors: {
            "editor.background": "#272822",
            "editor.foreground": "#f8f8f2",
            "editor.lineHighlightBackground": "#3e3d32",
            "editorLineNumber.foreground": "#75715e",
          },
        });

        monaco.editor.defineTheme("solarized-dark", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "", foreground: "#839496", background: "#002b36" },
            { token: "comment", foreground: "#586e75" },
            { token: "keyword", foreground: "#859900" },
            { token: "number", foreground: "#d33682" },
            { token: "string", foreground: "#2aa198" },
            { token: "identifier", foreground: "#b58900" },
          ],
          colors: {
            "editor.background": "#002b36",
            "editor.foreground": "#839496",
            "editor.lineHighlightBackground": "#073642",
            "editorLineNumber.foreground": "#586e75",
          },
        });

        monaco.editor.defineTheme("solarized-light", {
          base: "vs",
          inherit: true,
          rules: [
            { token: "", foreground: "#657b83", background: "#fdf6e3" },
            { token: "comment", foreground: "#93a1a1" },
            { token: "keyword", foreground: "#859900" },
            { token: "number", foreground: "#d33682" },
            { token: "string", foreground: "#2aa198" },
            { token: "identifier", foreground: "#b58900" },
          ],
          colors: {
            "editor.background": "#fdf6e3",
            "editor.foreground": "#657b83",
            "editor.lineHighlightBackground": "#eee8d5",
            "editorLineNumber.foreground": "#93a1a1",
          },
        });

        monaco.editor.defineTheme("nord", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "", foreground: "#d8dee9", background: "#2e3440" },
            { token: "comment", foreground: "#4c566a" },
            { token: "keyword", foreground: "#81a1c1" },
            { token: "number", foreground: "#b48ead" },
            { token: "string", foreground: "#a3be8c" },
            { token: "identifier", foreground: "#ebcb8b" },
          ],
          colors: {
            "editor.background": "#2e3440",
            "editor.foreground": "#d8dee9",
            "editor.lineHighlightBackground": "#3b4252",
            "editorLineNumber.foreground": "#4c566a",
          },
        });

        monaco.editor.defineTheme("gruvbox", {
          base: "vs-dark",
          inherit: true,
          rules: [
            { token: "", foreground: "#ebdbb2", background: "#282828" },
            { token: "comment", foreground: "#665c54" },
            { token: "keyword", foreground: "#fb4934" },
            { token: "number", foreground: "#d3869b" },
            { token: "string", foreground: "#b8bb26" },
            { token: "identifier", foreground: "#fabd2f" },
          ],
          colors: {
            "editor.background": "#282828",
            "editor.foreground": "#ebdbb2",
            "editor.lineHighlightBackground": "#3c3836",
            "editorLineNumber.foreground": "#665c54",
          },
        });

        const {
          storedMinimap,
          storedWordWrap,
          storedFontSize,
          storedLineNumbers,
          storedRenderWhitespace,
          storedTheme,
          storedAutoClosingBrackets,
          storedAutoSaveInterval,
          storedAutoSaveEnabled,
          storedLanguage,
        } = getStoredSettings();

        editor = monaco.editor.create(document.getElementById("editor"), {
          value: document.getElementById("autoSaveEnabled").checked ? localStorage.getItem("editorContent") || defaultCode : defaultCode,
          language: storedLanguage || "javascript",
          theme: storedTheme || "vs-dark",
          automaticLayout: true,
          minimap: { enabled: storedMinimap ? storedMinimap === "true" : false },
          wordWrap: storedWordWrap === "true" ? "on" : "off",
          fontSize: parseInt(storedFontSize ? Number(storedFontSize) : 13),
          lineNumbers: storedLineNumbers ? (storedLineNumbers === "true" ? "on" : "off") : "on",
          autoClosingBrackets: storedAutoClosingBrackets ? (storedAutoClosingBrackets === "true" ? "always" : "never") : "always",
          renderWhitespace: storedRenderWhitespace ? (storedRenderWhitespace === "true" ? "all" : "none") : "none",
          highlightActiveLine: true,
          lineNumbersMinChars: 2,
        });

        let selectionsContainer;
        let rightSelector;
        let leftSelector;
        let selectorMenu;
        let globalPoseMenu = 0;
        let startPosition;
        let isSelecting = false;
        let disabledMove = false;
        let tapsHeight = 40; // assuming you have some element on top that takes some height

        function initializeSelector() {
          selectionsContainer = document.createElement("div");
          selectionsContainer.className = "selections hidden";

          rightSelector = document.createElement("div");
          rightSelector.className = "selectors right-selector";
          leftSelector = document.createElement("div");
          leftSelector.className = "selectors left-selector";

          selectionsContainer.appendChild(rightSelector);
          selectionsContainer.appendChild(leftSelector);

          const editorScrollableNode = document.querySelector(".lines-content.monaco-editor-background");
          editorScrollableNode.insertAdjacentElement("afterbegin", selectionsContainer);

          selectorMenu = document.createElement("div");
          const outsetContainer = document.createElement("div");
          outsetContainer.className = "outset-shit-select";

          const leftArrow = document.createElement("div");
          leftArrow.className = "right-arrow-mnc left";
          leftArrow.ontouchstart = function () {
            this.classList.add("hovered");
          };
          leftArrow.ontouchmove = function () {
            this.classList.remove("hovered");
          };

          let currentScrollPosition = 0;
          leftArrow.ontouchend = function () {
            this.classList.remove("hovered");
            const containerWidth = outsetContainer.offsetWidth;
            let newScrollPosition = currentScrollPosition - containerWidth;
            if (newScrollPosition < 0) {
              newScrollPosition = 0;
            }
            outsetContainer.scrollTo({
              left: newScrollPosition,
              behavior: "smooth",
            });
            currentScrollPosition = newScrollPosition;
            if (newScrollPosition < 5) {
              selectorMenu.classList.remove("scrolled");
            }
          };

          const rightArrow = document.createElement("div");
          rightArrow.className = "right-arrow-mnc";
          rightArrow.ontouchstart = function () {
            this.classList.add("hovered");
          };
          rightArrow.ontouchmove = function () {
            this.classList.remove("hovered");
          };

          rightArrow.ontouchend = function () {
            this.classList.remove("hovered");
            const containerWidth = outsetContainer.offsetWidth;
            const scrollWidth = outsetContainer.scrollWidth;
            let newScrollPosition = currentScrollPosition + containerWidth;
            if (newScrollPosition > scrollWidth) {
              newScrollPosition = scrollWidth;
            }
            outsetContainer.scrollTo({
              left: newScrollPosition,
              behavior: "smooth",
            });
            currentScrollPosition = newScrollPosition;
            selectorMenu.classList.add("scrolled");
          };

          selectorMenu.appendChild(outsetContainer);
          selectorMenu.appendChild(rightArrow);
          selectorMenu.appendChild(leftArrow);

          editorScrollableNode.insertAdjacentElement("afterbegin", selectorMenu);

          let lastTapTime = 0;
          const doubleTapDelay = 400; // milliseconds

          document.addEventListener("touchend", (event) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;

            if (tapLength < doubleTapDelay && tapLength > 0) {
              // Double tap detected
              const touch = event.changedTouches[0];
              const target = editor.getTargetAtClientPoint(touch.clientX, touch.clientY);

              if (target && target.position) {
                const model = editor.getModel();
                const word = model.getWordAtPosition(target.position);

                if (word) {
                  const selection = new monaco.Selection(target.position.lineNumber, word.startColumn, target.position.lineNumber, word.endColumn);
                  editor.setSelection(selection);
                  event.preventDefault();
                }
              }
            }

            lastTapTime = currentTime;
          });

          function handleSelectorTouch(selector, isLeft) {
            let touchStartPos;
            let initialSelection;
            let touchMoved = false;

            selector.addEventListener("touchstart", (event) => {
              const touch = event.touches[0];
              touchStartPos = { x: touch.clientX, y: touch.clientY };
              initialSelection = editor.getSelection();
              touchMoved = false;
              event.preventDefault();
              disabledMove = true;
            });

            selector.addEventListener("touchmove", (event) => {
              const touch = event.touches[0];
              const target = editor.getTargetAtClientPoint(touch.clientX, touch.clientY);

              if (target && target.position) {
                const newSelection = isLeft
                  ? new monaco.Selection(target.position.lineNumber, target.position.column, initialSelection.endLineNumber, initialSelection.endColumn)
                  : new monaco.Selection(initialSelection.startLineNumber, initialSelection.startColumn, target.position.lineNumber, target.position.column);
                editor.setSelection(newSelection);
                touchMoved = true;
              }
              event.preventDefault();
            });

            selector.addEventListener("touchend", (event) => {
              if (!touchMoved) {
                const touch = event.changedTouches[0];
                const target = editor.getTargetAtClientPoint(touch.clientX, touch.clientY);

                if (target && target.position) {
                  const newSelection = isLeft
                    ? new monaco.Selection(target.position.lineNumber, target.position.column, initialSelection.endLineNumber, initialSelection.endColumn)
                    : new monaco.Selection(initialSelection.startLineNumber, initialSelection.startColumn, target.position.lineNumber, target.position.column);
                  editor.setSelection(newSelection);
                }
              }
              touchStartPos = null;
              initialSelection = null;
              touchMoved = false;
            });
          }

          handleSelectorTouch(leftSelector, true);
          handleSelectorTouch(rightSelector, false);
        }

        function selectAll() {
          editor.focus();
          const fullRange = editor.getModel().getFullModelRange();
          editor.setSelection(fullRange);
        }

        function copy() {
          const selection = editor.getSelection();
          const selectedText = selection.isEmpty() ? editor.getModel().getValue() : editor.getModel().getValueInRange(selection);
          navigator.clipboard
            .writeText(selectedText)
            .then(() => {
              console.log("Copied to clipboard");
              showNotification("Copied to clipboard");
            })
            .catch((err) => {
              console.error("Error in copying", err);
              showError("Error in copying");
            });
        }

        function copyWithCodeBlock() {
          const selection = editor.getSelection();
          const language = document.getElementById("language").value;
          const lang = language === "javascript" ? "js" : language === "typescript" ? "ts" : "";
          const selectedText = `\`\`\`${lang}\n${selection.isEmpty() ? editor.getModel().getValue() : editor.getModel().getValueInRange(selection)}\n\`\`\``;
          navigator.clipboard
            .writeText(selectedText)
            .then(() => {
              console.log("Copied to clipboard");
              showNotification("Copied to clipboard");
            })
            .catch((err) => {
              console.error("Error in copying", err);
              showError("Error in copying");
            });
        }

        function cut() {
          const selection = editor.getSelection();
          const selectedText = editor.getModel().getValueInRange(selection);
          navigator.clipboard
            .writeText(selectedText)
            .then(() => {
              editor.executeEdits("", [{ range: selection, text: "" }]);
            })
            .catch((err) => {
              editor.executeEdits("", [{ range: selection, text: "" }]);
            });
          editor.focus();
        }

        function paste() {
          navigator.clipboard
            .readText()
            .then((text) => {
              const selection = editor.getSelection();
              editor.executeEdits("", [{ range: selection, text }]);
              console.log("Pasted from clipboard");
            })
            .catch((err) => {
              console.error("Failed to paste: ", err);
            });
        }

        function formatSelection() {
          document.activeElement?.blur();
          editor.getAction("editor.action.formatSelection").run();
        }

        window.copy = copy;
        window.copyWithCodeBlock = copyWithCodeBlock;
        window.cut = cut;
        window.paste = paste;
        window.formatSelection = formatSelection;
        window.selectAll = selectAll;

        function getLineYCoordinate(position) {
          const lineTop = editor.getTopForLineNumber(position.lineNumber);
          const editorCoords = editorElement.getBoundingClientRect();
          return window.scrollY + editorCoords.top + lineTop - tapsHeight;
        }

        function isPositionInSelection(position) {
          const selection = editor.getSelection();
          if (!selection || selection.isEmpty()) {
            return false;
          }

          const startPosition = selection.getStartPosition();
          const endPosition = selection.getEndPosition();

          return (
            (position.lineNumber > startPosition.lineNumber || (position.lineNumber === startPosition.lineNumber && position.column >= startPosition.column)) &&
            (position.lineNumber < endPosition.lineNumber || (position.lineNumber === endPosition.lineNumber && position.column <= endPosition.column))
          );
        }

        const editorElement = document.getElementById("editor");
        const leftLength = document.querySelector(".monaco-editor .margin").offsetWidth;

        editorElement.addEventListener("touchstart", (event) => {
          if (selectorMenu.contains(event.target) || selectionsContainer.contains(event.target)) {
            event.stopPropagation();
            event.preventDefault();
          }
          const touch = event.touches[0];
          const target = editor.getTargetAtClientPoint(touch.clientX, touch.clientY);
          if (target && target.position) startPosition = target.position;
        });

        editorElement.addEventListener("touchend", () => {
          if (isSelecting) isSelecting = false;
          if (disabledMove) disabledMove = false;
        });

        editorElement.addEventListener("touchmove", (event) => {

          if (disabledMove) {
            event.preventDefault();
            event.stopPropagation();
          }

          if (startPosition && isSelecting) {
            event.preventDefault();
            event.stopPropagation();
            const touch = event.touches[0];
            const target = editor.getTargetAtClientPoint(touch.clientX, touch.clientY);
            if (target && target.position) {
              editor.setSelection(new monaco.Selection(startPosition.lineNumber, startPosition.column, target.position.lineNumber, target.position.column));
              isSelecting = true;
            }
          }
        });

        editor.onDidChangeCursorSelection((e) => {
          if (!isMobile()) return;
          const selection = e.selection;
          const startPosition = selection.getStartPosition();
          const endPosition = selection.getEndPosition();

          if (selection.isEmpty()) {
            const selectorMenu = document.querySelector(".arrow-container");
            selectorMenu.style.display = "none";
            selectionsContainer.classList.add("hidden");
            editor.focus();
            return;
          }

          const startLineTop = editor.getTopForLineNumber(startPosition.lineNumber);
          const endLineTop = editor.getTopForLineNumber(endPosition.lineNumber);

          const startCoords = editor.getScrolledVisiblePosition(startPosition);
          const endCoords = editor.getScrolledVisiblePosition(endPosition);

          if (startCoords && endCoords) {
            const editorCoords = editorElement.getBoundingClientRect();

            const leftSelectorX = editorCoords.left + startCoords.left - leftLength;
            const leftSelectorY = editorCoords.top + startLineTop - tapsHeight;
            const rightSelectorX = editorCoords.left + endCoords.left - leftLength;
            const rightSelectorY = editorCoords.top + endLineTop - tapsHeight;

            leftSelector.style.transform = `translateX(${leftSelectorX - 30}px) translateY(${leftSelectorY - 8}px)`;
            rightSelector.style.transform = `translateX(${rightSelectorX - 30}px) translateY(${rightSelectorY - 8}px)`;
            globalPoseMenu = leftSelectorY - 50;
          }
          selectionsContainer.classList.remove("hidden");
          showContextMenu();
        });

        initializeSelector();

        function showContextMenu() {
          const selectorMenu = document.querySelector(".arrow-container");
          selectorMenu.style.display = "grid";
          document.activeElement?.blur();
        }

        editorElement.addEventListener("click", (event) => {
          event.stopPropagation();
        });

        function selectMove(dir) {
          const selection = editor.getSelection();
          let { startLineNumber: l, startColumn: c } = selection;
          let { endLineNumber: el, endColumn: ec } = selection;
          const model = editor.getModel();
          const maxLine = model.getLineCount();

          const isCollapsed = () => l === el && c === ec;

          switch (dir) {
            case "left": if (c > 1) { c--; while (isCollapsed() && c > 1) c--; } else if (l > 1) { l--; c = model.getLineMaxColumn(l); while (isCollapsed() && l > 1) { l--; c = model.getLineMaxColumn(l); } } break;
            case "right": if (c < model.getLineMaxColumn(l)) { c++; while (isCollapsed() && c < model.getLineMaxColumn(l)) c++; } else if (l < maxLine) { l++; c = 1; while (isCollapsed() && l < maxLine) { l++; c = 1; } } break;
            case "up": if (l > 1) { l--; c = Math.min(c, model.getLineMaxColumn(l)); while (isCollapsed() && l > 1) { l--; c = Math.min(c, model.getLineMaxColumn(l)); } } break;
            case "down": if (el < maxLine) { el++; c = Math.min(c, model.getLineMaxColumn(el)); while (isCollapsed() && el < maxLine) { el++; c = Math.min(c, model.getLineMaxColumn(el)); } } break;
            case "home": l = 1; c = 1; break;
            case "end": el = maxLine; ec = model.getLineMaxColumn(el); break;
          }

          editor.setSelection(new monaco.Selection(l, c, el, ec));
        }

        window.selectMove = selectMove;

      });

      startAutoSave();
    }

    let autoSaveTimer;
    function startAutoSave() {
      const interval = parseInt(document.getElementById("autoSaveInterval").value) * 1000;
      const enabled = document.getElementById("autoSaveEnabled").checked;

      if (autoSaveTimer) clearInterval(autoSaveTimer);
      if (!enabled) return;

      autoSaveTimer = setInterval(() => {
        const content = editor.getValue();
        localStorage.setItem("editorContent", content);
      }, interval);
    }

    function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }

    async function formatCode() { await editor.getAction("editor.action.formatDocument").run(); }

    document.addEventListener("keydown", function (event) {
      if (event.ctrlKey && event.key === "s") {
        event.preventDefault();
        saveCode();
      }
    });

    function saveCode() {
      const code = editor.getValue();
      const fileName = document.getElementById("filename").value || "minecraft_script.js";
      const blob = new Blob([code], { type: "text/javascript" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
    }

    function compileTypeScript() {
      if (document.getElementById("language").value !== "typescript") {
        showError("Compilation is only available for TypeScript files");
        return;
      }

      const code = editor.getValue();

      try {
        const result = ts.transpileModule(code, {
          compilerOptions: {
            target: ts.ScriptTarget.ES2020,
            module: ts.ModuleKind.ESNext,
            strict: true
          }
        });

        document.getElementById("language").value = "javascript";
        monaco.editor.setModelLanguage(editor.getModel(), "javascript");
        editor.setValue(result.outputText);
        showNotification("Successfully compiled to JavaScript");
        saveSetting();
      } catch (error) {
        showError(`Compilation error: ${error.message}`);
        console.error("TypeScript compilation error:", error);
      }
    }

    // Initialize file system when the editor is ready
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("filename").value = "index.js";
      const compileBtn = document.getElementById("compileBtn");
      const language = document.getElementById("language").value;
      if (compileBtn) {
        compileBtn.style.display = language === "typescript" ? "block" : "none";
      }
    });
    
    // Initialize file system after editor is fully loaded
    function initEditor() {
      // Setup a proper initialization sequence
      async function initAll() {
        await loadTypeDefinitions();
        
        // After the editor is fully initialized, setup the file system
        if (window.editor) {
          initializeFileSystem();
        } else {
          console.error("Editor initialization failed");
        }
      }
      
      initAll();
    }

    // Make sure the editor instance is ready before attempting to use it
    function initializeFileSystem() {
      // Load workspace from localStorage if available
      const savedWorkspace = localStorage.getItem("workspace");
      if (savedWorkspace) {
        try {
          workspace = JSON.parse(savedWorkspace);
          
          // If there's no current file selected but there are files, select the first one
          if (!workspace.currentFile && Object.keys(workspace.files).length > 0) {
            const firstFilePath = Object.keys(workspace.files)[0];
            workspace.currentFile = firstFilePath;
            workspace.currentPath = getPathFromFilePath(firstFilePath);
          }
        } catch (e) {
          console.error("Failed to load workspace:", e);
          workspace = { files: {}, currentFile: null, currentPath: null, workspaceName: "MyWorkspace" };
        }
      } else {
        // Create a default file if workspace is empty
        createDefaultFile();
      }
      
      renderFileTree();
      
      // Load current file if one is selected
      if (workspace.currentFile && editor) {
        openFile(workspace.currentFile);
      }
      
      // Set up event listeners for file operations
      setupFileOperations();
    }
    
    function setupFileOperations() {
      // New file button
      document.getElementById("new-file").addEventListener("click", function() {
        showFileModal("new-file-modal");
      });
      
      // New folder button
      document.getElementById("new-folder").addEventListener("click", function() {
        showFileModal("new-folder-modal");
      });
      
      // Download workspace button
      document.getElementById("download-workspace").addEventListener("click", downloadWorkspace);
      
      // Create file button
      document.getElementById("create-file-btn").addEventListener("click", function() {
        const fileName = document.getElementById("new-file-name").value.trim();
        if (!fileName) {
          showError("Please enter a file name");
          return;
        }
        
        createNewFile(fileName);
        closeFileModal("new-file-modal");
      });
      
      // Create folder button
      document.getElementById("create-folder-btn").addEventListener("click", function() {
        const folderName = document.getElementById("new-folder-name").value.trim();
        if (!folderName) {
          showError("Please enter a folder name");
          return;
        }
        
        createNewFolder(folderName);
        closeFileModal("new-folder-modal");
      });
      
      // Rename button
      document.getElementById("rename-btn").addEventListener("click", function() {
        const newName = document.getElementById("rename-input").value.trim();
        if (!newName) {
          showError("Please enter a name");
          return;
        }
        
        const fileItem = document.querySelector(".file-tree-item.renaming");
        if (!fileItem) return;
        
        const path = fileItem.getAttribute("data-path");
        const isFolder = fileItem.getAttribute("data-type") === "folder";
        
        renameFileOrFolder(path, newName, isFolder);
        fileItem.classList.remove("renaming");
        closeFileModal("rename-modal");
      });
      
      // Delete confirmation button
      document.getElementById("confirm-delete-btn").addEventListener("click", function() {
        const fileItem = document.querySelector(".file-tree-item.deleting");
        if (!fileItem) return;
        
        const path = fileItem.getAttribute("data-path");
        const isFolder = fileItem.getAttribute("data-type") === "folder";
        
        deleteFileOrFolder(path, isFolder);
        fileItem.classList.remove("deleting");
        closeFileModal("delete-confirm-modal");
      });
      
      // Context menu items
      document.getElementById("context-rename").addEventListener("click", function() {
        const target = document.querySelector(".file-tree-item.context-menu-target");
        if (!target) return;
        
        target.classList.add("renaming");
        target.classList.remove("context-menu-target");
        
        const name = target.querySelector(".file-name").textContent;
        document.getElementById("rename-input").value = name;
        
        hideContextMenu();
        showFileModal("rename-modal");
      });
      
      document.getElementById("context-duplicate").addEventListener("click", function() {
        const target = document.querySelector(".file-tree-item.context-menu-target");
        if (!target) return;
        
        const path = target.getAttribute("data-path");
        const isFolder = target.getAttribute("data-type") === "folder";
        
        duplicateFileOrFolder(path, isFolder);
        target.classList.remove("context-menu-target");
        
        hideContextMenu();
      });
      
      document.getElementById("context-delete").addEventListener("click", function() {
        const target = document.querySelector(".file-tree-item.context-menu-target");
        if (!target) return;
        
        target.classList.add("deleting");
        target.classList.remove("context-menu-target");
        
        const isFolder = target.getAttribute("data-type") === "folder";
        const name = target.querySelector(".file-name").textContent;
        
        document.getElementById("delete-confirm-message").textContent = `Are you sure you want to delete ${isFolder ? "folder" : "file"} "${name}"?`;
        
        hideContextMenu();
        showFileModal("delete-confirm-modal");
      });
      
      // Close context menu when clicking outside
      document.addEventListener("click", function(e) {
        if (!e.target.closest("#file-context-menu")) {
          hideContextMenu();
        }
      });
    }

    function createDefaultFile() {
      const fileName = "index.js";
      workspace.files[fileName] = {
        content: defaultCode,
        language: "javascript",
        created: Date.now(),
        modified: Date.now()
      };
      workspace.currentFile = fileName;
      workspace.currentPath = "";
      saveWorkspace();
    }
    
    function renderFileTree() {
      const fileTreeContent = document.getElementById("file-tree-content");
      fileTreeContent.innerHTML = "";
      
      // Organize files into a folder structure
      const tree = {};
      
      for (const filePath in workspace.files) {
        const pathParts = filePath.split("/");
        let currentLevel = tree;
        
        // Create folder structure for this file
        for (let i = 0; i < pathParts.length - 1; i++) {
          const folder = pathParts[i];
          if (!currentLevel[folder]) {
            currentLevel[folder] = {};
          }
          currentLevel = currentLevel[folder];
        }
        
        // Add the file at the last level
        const fileName = pathParts[pathParts.length - 1];
        currentLevel[fileName] = { type: "file", path: filePath };
      }
      
      // Render the tree structure
      renderFolderStructure(tree, fileTreeContent, "");
    }
    
    function renderFolderStructure(tree, parentElement, path) {
      // Sort items: folders first, then files, both alphabetically
      const sortedItems = Object.keys(tree).sort((a, b) => {
        const aIsFile = tree[a].type === "file";
        const bIsFile = tree[b].type === "file";
        
        if (aIsFile && !bIsFile) return 1;
        if (!aIsFile && bIsFile) return -1;
        return a.localeCompare(b);
      });
      
      for (const name of sortedItems) {
        const item = tree[name];
        
        if (item.type === "file") {
          // This is a file
          const fileElement = createFileElement(name, item.path);
          parentElement.appendChild(fileElement);
        } else {
          // This is a folder
          const folderPath = path ? `${path}/${name}` : name;
          const folderElement = createFolderElement(name, folderPath);
          const folderContent = document.createElement("div");
          folderContent.className = "file-tree-folder-content";
          
          renderFolderStructure(item, folderContent, folderPath);
          
          folderElement.appendChild(folderContent);
          parentElement.appendChild(folderElement);
        }
      }
    }
    
    function createFileElement(name, path) {
      const file = document.createElement("div");
      file.className = `file-tree-item${workspace.currentFile === path ? " active" : ""}`;
      file.setAttribute("data-path", path);
      file.setAttribute("data-type", "file");
      
      // Determine file icon based on extension
      const extension = name.split(".").pop().toLowerCase();
      let iconClass = "📄"; // Default file icon
      
      if (extension === "js") iconClass = "📜";
      else if (extension === "ts") iconClass = "📘";
      else if (extension === "json") iconClass = "🔧";
      else if (extension === "html") iconClass = "🌐";
      else if (extension === "css") iconClass = "🎨";
      else if (extension === "md") iconClass = "📝";
      
      file.innerHTML = `
        <span class="file-icon">${iconClass}</span>
        <span class="file-name">${name}</span>
        <div class="file-actions">
          <button class="file-action" title="Rename"><span>✏️</span></button>
          <button class="file-action" title="Delete"><span>🗑️</span></button>
        </div>
      `;
      
      // Add event listener to open file on click
      file.addEventListener("click", function(e) {
        if (e.target.closest(".file-actions")) return;
        openFile(path);
      });
      
      // Add context menu
      file.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        showContextMenu(e, file);
      });
      
      // Add action buttons behavior
      const actions = file.querySelector(".file-actions");
      if (actions) {
        const buttons = actions.querySelectorAll("button");
        
        // Rename button
        if (buttons[0]) {
          buttons[0].addEventListener("click", function(e) {
            e.stopPropagation();
            file.classList.add("renaming");
            document.getElementById("rename-input").value = name;
            showFileModal("rename-modal");
          });
        }
        
        // Delete button
        if (buttons[1]) {
          buttons[1].addEventListener("click", function(e) {
            e.stopPropagation();
            file.classList.add("deleting");
            document.getElementById("delete-confirm-message").textContent = `Are you sure you want to delete file "${name}"?`;
            showFileModal("delete-confirm-modal");
          });
        }
      }
      
      return file;
    }
    
    function createFolderElement(name, path) {
      const folder = document.createElement("div");
      folder.className = "file-tree-folder";
      
      const folderItem = document.createElement("div");
      folderItem.className = "file-tree-item";
      folderItem.setAttribute("data-path", path);
      folderItem.setAttribute("data-type", "folder");
      
      folderItem.innerHTML = `
        <span class="file-icon folder-icon">📁</span>
        <span class="file-name">${name}</span>
        <div class="file-actions">
          <button class="file-action" title="New File"><span>+</span></button>
          <button class="file-action" title="Rename"><span>✏️</span></button>
          <button class="file-action" title="Delete"><span>🗑️</span></button>
        </div>
      `;
      
      // Toggle folder expand/collapse
      folderItem.addEventListener("click", function(e) {
        if (e.target.closest(".file-actions")) return;
        folder.classList.toggle("expanded");
        
        // Update folder icon
        const icon = folderItem.querySelector(".folder-icon");
        if (icon) {
          icon.textContent = folder.classList.contains("expanded") ? "📂" : "📁";
        }
      });
      
      // Add context menu
      folderItem.addEventListener("contextmenu", function(e) {
        e.preventDefault();
        showContextMenu(e, folderItem);
      });
      
      // Add action buttons behavior
      const actions = folderItem.querySelector(".file-actions");
      if (actions) {
        const buttons = actions.querySelectorAll("button");
        
        // New file button
        if (buttons[0]) {
          buttons[0].addEventListener("click", function(e) {
            e.stopPropagation();
            workspace.currentPath = path;
            showFileModal("new-file-modal");
          });
        }
        
        // Rename button
        if (buttons[1]) {
          buttons[1].addEventListener("click", function(e) {
            e.stopPropagation();
            folderItem.classList.add("renaming");
            document.getElementById("rename-input").value = name;
            showFileModal("rename-modal");
          });
        }
        
        // Delete button
        if (buttons[2]) {
          buttons[2].addEventListener("click", function(e) {
            e.stopPropagation();
            folderItem.classList.add("deleting");
            document.getElementById("delete-confirm-message").textContent = `Are you sure you want to delete folder "${name}" and all its contents?`;
            showFileModal("delete-confirm-modal");
          });
        }
      }
      
      folder.appendChild(folderItem);
      return folder;
    }
    
    function openFile(path) {
      if (!workspace.files[path]) return;
      
      // Save current file before switching
      if (workspace.currentFile && workspace.currentFile !== path) {
        saveCurrentFile();
      }
      
      const fileData = workspace.files[path];
      
      // Set editor content and language
      editor.setValue(fileData.content || "");
      monaco.editor.setModelLanguage(editor.getModel(), fileData.language || getLanguageFromPath(path));
      
      // Update UI
      document.getElementById("filename").value = getFileNameFromPath(path);
      document.getElementById("language").value = fileData.language || getLanguageFromPath(path);
      
      // Update selected file in the tree
      const previousActive = document.querySelector(".file-tree-item.active");
      if (previousActive) {
        previousActive.classList.remove("active");
      }
      
      const fileElement = document.querySelector(`.file-tree-item[data-path="${path}"]`);
      if (fileElement) {
        fileElement.classList.add("active");
        
        // Expand parent folders
        let parent = fileElement.parentElement;
        while (parent && parent.classList.contains("file-tree-folder-content")) {
          const folder = parent.parentElement;
          folder.classList.add("expanded");
          
          // Update folder icon
          const icon = folder.querySelector(".folder-icon");
          if (icon) {
            icon.textContent = "📂";
          }
          
          parent = folder.parentElement;
        }
        
        // Scroll into view
        fileElement.scrollIntoView({ behavior: "smooth", block: "center" });
      }
      
      workspace.currentFile = path;
      saveWorkspace();
    }
    
    function saveCurrentFile() {
      if (!workspace.currentFile) return;
      
      const content = editor.getValue();
      const language = document.getElementById("language").value;
      
      workspace.files[workspace.currentFile].content = content;
      workspace.files[workspace.currentFile].language = language;
      workspace.files[workspace.currentFile].modified = Date.now();
      
      saveWorkspace();
      showNotification("File saved");
    }
    
    function createNewFile(fileName) {
      // Add extension if not provided
      if (!fileName.includes(".")) {
        const language = document.getElementById("language").value || "javascript";
        fileName += language === "javascript" ? ".js" : language === "typescript" ? ".ts" : ".txt";
      }
      
      // Create the full path
      const path = workspace.currentPath ? `${workspace.currentPath}/${fileName}` : fileName;
      
      // Check if file already exists
      if (workspace.files[path]) {
        showError(`File ${fileName} already exists`);
        return;
      }
      
      // Create file
      workspace.files[path] = {
        content: "",
        language: getLanguageFromPath(path),
        created: Date.now(),
        modified: Date.now()
      };
      
      saveWorkspace();
      renderFileTree();
      openFile(path);
      showNotification(`File ${fileName} created`);
    }
    
    function createNewFolder(folderName) {
      // Create the full path
      const path = workspace.currentPath ? `${workspace.currentPath}/${folderName}` : folderName;
      
      // Check if any file starts with this path
      for (const filePath in workspace.files) {
        if (filePath.startsWith(`${path}/`)) {
          showError(`Folder ${folderName} already exists`);
          return;
        }
      }
      
      // Create an empty file in the folder so it appears in the tree
      const placeholderPath = `${path}/.placeholder.md`;
      workspace.files[placeholderPath] = {
        content: "# This is a placeholder file\nYou can safely delete it.",
        language: "markdown",
        created: Date.now(),
        modified: Date.now(),
        isPlaceholder: true
      };
      
      saveWorkspace();
      renderFileTree();
      showNotification(`Folder ${folderName} created`);
    }
    
    function renameFileOrFolder(path, newName, isFolder) {
      if (isFolder) {
        // Rename folder (all files inside the folder)
        const updatedFiles = {};
        const prefix = path + "/";
        const newPrefix = getPathFromFilePath(path) + (getPathFromFilePath(path) ? "/" : "") + newName + "/";
        
        // Update all files in the folder
        for (const filePath in workspace.files) {
          if (filePath.startsWith(prefix)) {
            const relativePath = filePath.substring(prefix.length);
            const newPath = newPrefix + relativePath;
            updatedFiles[newPath] = workspace.files[filePath];
          } else {
            updatedFiles[filePath] = workspace.files[filePath];
          }
        }
        
        // Update currentFile if it was in the renamed folder
        if (workspace.currentFile && workspace.currentFile.startsWith(prefix)) {
          const relativePath = workspace.currentFile.substring(prefix.length);
          workspace.currentFile = newPrefix + relativePath;
        }
        
        workspace.files = updatedFiles;
      } else {
        // Rename file
        const fileData = workspace.files[path];
        if (!fileData) return;
        
        const newPath = getPathFromFilePath(path) + (getPathFromFilePath(path) ? "/" : "") + newName;
        
        // Check if target already exists
        if (workspace.files[newPath]) {
          showError(`File ${newName} already exists`);
          return;
        }
        
        // Add the file with the new name
        workspace.files[newPath] = fileData;
        
        // Delete the old file
        delete workspace.files[path];
        
        // Update currentFile if it was the renamed file
        if (workspace.currentFile === path) {
          workspace.currentFile = newPath;
        }
      }
      
      saveWorkspace();
      renderFileTree();
      showNotification(`${isFolder ? "Folder" : "File"} renamed to ${newName}`);
    }
    
    function duplicateFileOrFolder(path, isFolder) {
      if (isFolder) {
        // Duplicate folder (all files inside the folder)
        const prefix = path + "/";
        const newName = path + " (copy)";
        const newPrefix = newName + "/";
        
        // Copy all files in the folder
        for (const filePath in workspace.files) {
          if (filePath.startsWith(prefix)) {
            const relativePath = filePath.substring(prefix.length);
            const newPath = newPrefix + relativePath;
            workspace.files[newPath] = JSON.parse(JSON.stringify(workspace.files[filePath]));
            workspace.files[newPath].modified = Date.now();
          }
        }
      } else {
        // Duplicate file
        const fileData = workspace.files[path];
        if (!fileData) return;
        
        const fileName = getFileNameFromPath(path);
        const baseName = fileName.includes(".") ? fileName.substring(0, fileName.lastIndexOf(".")) : fileName;
        const extension = fileName.includes(".") ? fileName.substring(fileName.lastIndexOf(".")) : "";
        
        let newFileName = `${baseName} (copy)${extension}`;
        let newPath = getPathFromFilePath(path) + (getPathFromFilePath(path) ? "/" : "") + newFileName;
        
        // Handle case where copy already exists
        let copyNumber = 2;
        while (workspace.files[newPath]) {
          newFileName = `${baseName} (copy ${copyNumber})${extension}`;
          newPath = getPathFromFilePath(path) + (getPathFromFilePath(path) ? "/" : "") + newFileName;
          copyNumber++;
        }
        
        // Add the new file
        workspace.files[newPath] = JSON.parse(JSON.stringify(fileData));
        workspace.files[newPath].modified = Date.now();
      }
      
      saveWorkspace();
      renderFileTree();
      showNotification(`${isFolder ? "Folder" : "File"} duplicated`);
    }
    
    function deleteFileOrFolder(path, isFolder) {
      if (isFolder) {
        // Delete folder (all files inside the folder)
        const prefix = path + "/";
        const filesToDelete = [];
        
        // Find all files to delete
        for (const filePath in workspace.files) {
          if (filePath.startsWith(prefix)) {
            filesToDelete.push(filePath);
          }
        }
        
        // Delete the files
        filesToDelete.forEach(filePath => {
          delete workspace.files[filePath];
        });
        
        // If current file was deleted, select another file
        if (workspace.currentFile && workspace.currentFile.startsWith(prefix)) {
          workspace.currentFile = null;
          selectAnotherFile();
        }
      } else {
        // Delete file
        delete workspace.files[path];
        
        // If current file was deleted, select another file
        if (workspace.currentFile === path) {
          workspace.currentFile = null;
          selectAnotherFile();
        }
      }
      
      saveWorkspace();
      renderFileTree();
      showNotification(`${isFolder ? "Folder" : "File"} deleted`);
    }
    
    function selectAnotherFile() {
      const fileKeys = Object.keys(workspace.files);
      if (fileKeys.length > 0) {
        openFile(fileKeys[0]);
      } else {
        // Create a default file if no files left
        createDefaultFile();
        renderFileTree();
      }
    }
    
    function downloadWorkspace() {
      // Create a JSON representation of the workspace
      const workspaceData = {
        name: workspace.workspaceName,
        files: workspace.files,
        exportDate: new Date().toISOString()
      };
      
      // Convert to JSON and create a Blob
      const jsonData = JSON.stringify(workspaceData, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      
      // Create a download link
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${workspace.workspaceName}.workspace.json`;
      a.click();
      
      // Clean up
      URL.revokeObjectURL(url);
      showNotification("Workspace downloaded");
    }
    
    function saveWorkspace() {
      try {
        localStorage.setItem("workspace", JSON.stringify(workspace));
      } catch (e) {
        console.error("Failed to save workspace:", e);
        showError("Failed to save workspace: " + e.message);
      }
    }
    
    // Helper functions
    function getFileNameFromPath(path) {
      return path.split("/").pop();
    }
    
    function getPathFromFilePath(filePath) {
      const parts = filePath.split("/");
      parts.pop(); // Remove the file name
      return parts.join("/");
    }
    
    function getLanguageFromPath(path) {
      const extension = path.split(".").pop().toLowerCase();
      
      if (extension === "js") return "javascript";
      if (extension === "ts") return "typescript";
      if (extension === "json") return "json";
      if (extension === "html") return "html";
      if (extension === "css") return "css";
      if (extension === "md") return "markdown";
      
      return "javascript"; // Default
    }
    
    function showContextMenu(e, target) {
      const contextMenu = document.getElementById("file-context-menu");
      
      // Remove existing target class
      const previousTarget = document.querySelector(".file-tree-item.context-menu-target");
      if (previousTarget) {
        previousTarget.classList.remove("context-menu-target");
      }
      
      // Set this element as the target
      target.classList.add("context-menu-target");
      
      // Position the menu
      contextMenu.style.display = "block";
      const x = e.clientX;
      const y = e.clientY;
      
      // Adjust position to ensure the menu stays within viewport
      const menuWidth = contextMenu.offsetWidth;
      const menuHeight = contextMenu.offsetHeight;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      if (x + menuWidth > windowWidth) {
        contextMenu.style.left = (x - menuWidth) + "px";
      } else {
        contextMenu.style.left = x + "px";
      }
      
      if (y + menuHeight > windowHeight) {
        contextMenu.style.top = (y - menuHeight) + "px";
      } else {
        contextMenu.style.top = y + "px";
      }
    }
    
    function hideContextMenu() {
      const contextMenu = document.getElementById("file-context-menu");
      contextMenu.style.display = "none";
      
      const target = document.querySelector(".file-tree-item.context-menu-target");
      if (target) {
        target.classList.remove("context-menu-target");
      }
    }
    
    function showFileModal(modalId) {
      document.getElementById(modalId).style.display = "block";
      
      // Focus on the input field if present
      const input = document.getElementById(modalId).querySelector("input[type=text]");
      if (input) {
        setTimeout(() => {
          input.focus();
          input.select();
        }, 100);
      }
    }
    
    function closeFileModal(modalId) {
      document.getElementById(modalId).style.display = "none";
      
      // Clean up any remaining class markers
      const renamingEl = document.querySelector(".file-tree-item.renaming");
      if (renamingEl) {
        renamingEl.classList.remove("renaming");
      }
      
      const deletingEl = document.querySelector(".file-tree-item.deleting");
      if (deletingEl) {
        deletingEl.classList.remove("deleting");
      }
    }

    // Initialize file system when the editor is ready
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("filename").value = "index.js";
      const compileBtn = document.getElementById("compileBtn");
      const language = document.getElementById("language").value;
      if (compileBtn) {
        compileBtn.style.display = language === "typescript" ? "block" : "none";
      }
      
      // Initialize file system after Monaco is loaded
      require(["vs/editor/editor.main"], function() {
        // Wait for editor to be initialized
        const checkInterval = setInterval(() => {
          if (window.editor) {
            clearInterval(checkInterval);
            initializeFileSystem();
          }
        }, 100);
      });
    });

    // Save content when closing the tab
    window.addEventListener("beforeunload", () => {
      localStorage.setItem("editorContent", editor.getValue());
    });

    function isMobile() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      return (
        /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(
          userAgent
        ) ||
        /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(
          userAgent.substr(0, 4)
        )
      );
    }
    initializeEditor();
    
    // Initialize the file system once the editor is ready
    function initEditorReady() {
      if (window.editor) {
        initEditor();
      } else {
        // Keep checking until editor is available
        setTimeout(initEditorReady, 100);
      }
    }
    
    // Start checking after editor initialization
    setTimeout(initEditorReady, 500);
  </script>
</body>

</html>